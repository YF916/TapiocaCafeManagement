name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8' # or any other version you need

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run tests
      run: |
        pytest ./tts/t_meeting_data_service.py
        pytest ./tts/t_meeting_resource.py

    - name: Log in to Docker Hub
      uses: docker/login-action@v1
      with:
        username: yf916
        password: dckr_pat_i7x7Agga9_4jd930HNVbZp6IoJw

    - uses: actions/checkout@v3
    - name: Build and push Docker image
      run: |
        docker build --platform linux/amd64 -t yf916/tapioca-cafe-management-service .
        docker push yf916/tapioca-cafe-management-service

    - name: Pull Docker image on EC2
      uses: appleboy/ssh-action@master
      with:
        host: 13.58.188.11
        username: ec2-user
        key: -----BEGIN RSA PRIVATE KEY-----
          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
          -----END RSA PRIVATE KEY-----
        script: |
          docker pull yf916/tapioca-cafe-management-service
          

#    - name: Pull Docker image on EC2
#      uses: appleboy/ssh-action@master
#      with:
#        host: ec2-13-58-188-11.us-east-2.compute.amazonaws.com
#        username: ec2-user
#        key:
#          -----BEGIN RSA PRIVATE KEY-----
#          MIIEowIBAAKCAQEAo664xZhu5HS2ca/KechOv073hg3m9Tgg7b3fz4UacBXsJtaB
#          /RwXY9vnHvPEPWJRiKh2a6VCQoQJoroyEz6FVa91NUz5bt0ncr7vh3IFjs1+8OYM
#          jH/PyVx305dcEIdvJ7xYYYW+dEEXoe6RCGiNASqHeTSXBNkOY2YQJVgSAFxFuKIF
#          UsPhUMVFRvtdMLi7Iolwr4F+55FFTYTIfFs3K9OPytAnQ2kJPqJbg8xOLiRSQgP0
#          vxeAujb+rrmWZvDwveDo22PzZngYq16RyicDI0MRVWmcWOVKkvLDfIUXtmYzFowk
#          08zR4z9WzhkkLhOQnyOw33AEuVx0wsm7AtC+wwIDAQABAoIBADKxZSZFPGrivrJc
#          +D9ZSxIy2bQZ0CK4HHKk8JDrrzFxiK7Kln2WWqQhseXDJ06/iXLigbJ6/xdsnzNX
#          qTSOk2rjKVC1ozazpYkDG1n+dTwx5pOjG9XTq724NqBAa1HvL/zFdzXU3xRQKIqN
#          QTuybaEj08s0/2SP+MXOEUgPi5uyeMvEquPGVKZxJThr6mJfWZH1FrDsMCtdfXZb
#          dLSnf013J/ASRadrC/X7agoZRe7GkYdwXU4mlG8YqpISBjsGkQPuhOdJVDYUJmDu
#          0fXQ80FHNicCmrk/xxoeA8O6wGFOJzr106w8Z/xBFrTNOVhno5NgLjc5XMEQvqu9
#          SwL/SbECgYEA4HhKUuUoln3VIawq1tjYx7PzSeASGzfJu+0pMnWYMgRJ3HI+B4yO
#          5lAq5nC5LIKFL8d4optwIQjaQo6wUUfqv3MPkk0SsXL/19fdBLVZ9/2zzugnusYY
#          uzUowH0i1IvKEeJ2jr5vJTslURP57hxw9jl0DeYGvd85LQpENlD96hsCgYEAuqyU
#          NFVZf8MpgYMDPi6vYU9ZY1aoS/fAdows4WLLS2uXGlAuQo3wtVocfocOpBkEkyXZ
#          7SsIn3q1zB8R9NP+aPVcJJl2z90w72w7EpqY/XJKFgPBUr/BzAWs4Ltriz9QLo8S
#          Vjl82am9iK+kQr/UUpfJbBDp/Vo9HUKkydI4yHkCgYEAonqv4dz6SiR/N8Z1o9qG
#          39cDzX+h243AOoVqgpnYNqwgAq+28qPtdAynYPJLN0qquXD7g0hcG61avz6lpdAW
#          vcm9hbrAQy3ovwYDd7sFippbovMsfueRU0EhZGOv6IXfGJ8CDkUOErcDRfLdwFtZ
#          8QCZXs4YJywDKPT7dw2dHe0CgYBUZzObdfvBiLx7koEk3HbvyLDh+YyezKZ482hX
#          gBPrRfpMK3S/Iu5zEQtRKj+0cpte7P5b/dkoQpNwd5vm1vNxAX9oDPtrgNdfadBL
#          2RrTfZmB2rDOeWVmmipQcm1tyHK4mnfwBI4u3FCWPNRIWfPmZDruYbdqliKL2FYp
#          6qNCAQKBgApznZyxK5rkW9RmumKx9hi4HMpWKiighsBJQf3Xd8096B6EyiRByILb
#          oa8xQtIWbgfZCfKh9Qwxohl7sraDfj5yn7ngbavB75e8xGIMBGvpyXrXK/R4F7hw
#          XrzxHNj6SJhEf5YvmTOpBD2VAszw+CurTSs86rOtJIR6HwaRnTQe
#          -----END RSA PRIVATE KEY-----
#        script: |
#          docker pull yf916/tapioca-cafe-management-service
